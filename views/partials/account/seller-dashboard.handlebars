<section id="products" class="account-section account-seller">
  <header class="section-header">
    <h2>K√™nh ng∆∞·ªùi b√°n</h2>
  </header>

  {{#if seller.productFlash}}
    <div class="alert alert-{{seller.productFlash.type}}">{{seller.productFlash.message}}</div>
  {{/if}}

  <div class="seller-dashboard-tabs" data-product-tabs>
    <div class="account-tabs seller-tab-nav" role="tablist">
      <button type="button" class="is-active" data-tab="create" role="tab" aria-selected="true">
        ƒêƒÉng s·∫£n ph·∫©m m·ªõi
      </button>
      <button type="button" data-tab="requests" role="tab" aria-selected="false">
        Y√™u c·∫ßu tham gia ƒë·∫•u gi√°{{#if seller.bidRequests.length}} ({{seller.bidRequests.length}}){{/if}}
      </button>
      <button type="button" data-tab="sales" role="tab" aria-selected="false">
        Qu·∫£n l√Ω b√°n h√†ng
      </button>
    </div>

    <div class="seller-tab-panels">
      <section class="seller-tab-panel is-active" data-tab-panel="create" role="tabpanel">
        <div class="account-panel account-panel--products">
          <div class="account-panel-main">
            <div class="account-card account-card--form">
              <h3>{{#if seller.editingProductId}}Ch·ªânh s·ª≠a s·∫£n ph·∫©m{{else}}ƒêƒÉng s·∫£n ph·∫©m m·ªõi{{/if}}</h3>
              <form method="post" action="/account/products" class="account-form account-form--product" enctype="multipart/form-data">
                {{#if seller.editingProductId}}
                  <input type="hidden" name="productId" value="{{seller.editingProductId}}" />
                {{/if}}
                <div class="account-form-grid account-form-grid--product">
                  <div class="form-field form-field--full {{#if seller.productErrors.title}}has-error{{/if}}">
                    <label for="product-title">T√™n s·∫£n ph·∫©m</label>
                    <input id="product-title" type="text" name="title" value="{{seller.productForm.title}}" placeholder="V√≠ d·ª•: M√°y ·∫£nh Sony A7C II..." required data-min-length="8" data-max-length="120" />
                    <p class="field-hint">T√™n n√™n r√µ r√†ng, d√†i t·ª´ 8‚Äì120 k√Ω t·ª±.</p>
                    {{#if seller.productErrors.title}}<span class="field-error">{{seller.productErrors.title}}</span>{{/if}}
                  </div>

                  <div class="form-field {{#if seller.productErrors.categoryId}}has-error{{/if}}">
                    <label for="product-category">Danh m·ª•c</label>
                    <select id="product-category" name="categoryId" required>
                      <option value="">‚Äî Ch·ªçn danh m·ª•c ‚Äî</option>
                      {{#each seller.categories}}
                        <option value="{{id}}" {{#if (eq ../seller.productForm.categoryId id)}}selected{{/if}}>{{name}}</option>
                      {{/each}}
                    </select>
                    {{#if seller.productErrors.categoryId}}<span class="field-error">{{seller.productErrors.categoryId}}</span>{{/if}}
                  </div>

                  <div class="form-field {{#if seller.productErrors.startPrice}}has-error{{/if}}">
                    <label for="product-start-price">Gi√° kh·ªüi ƒëi·ªÉm (VND)</label>
                    <input id="product-start-price" type="text" inputmode="numeric" name="startPrice" value="{{seller.productForm.startPrice}}" class="currency-input" data-min="1000" required />
                    <p class="field-hint">T·ªëi thi·ªÉu 1.000‚Ç´ v√† n√™n ph√π h·ª£p v·ªõi gi√° tr·ªã s·∫£n ph·∫©m.</p>
                    {{#if seller.productErrors.startPrice}}<span class="field-error">{{seller.productErrors.startPrice}}</span>{{/if}}
                  </div>

                  <div class="form-field {{#if seller.productErrors.stepPrice}}has-error{{/if}}">
                    <label for="product-step-price">B∆∞·ªõc gi√° (VND)</label>
                    <input id="product-step-price" type="text" inputmode="numeric" name="stepPrice" value="{{seller.productForm.stepPrice}}" class="currency-input" data-min="1000" required />
                    <p class="field-hint">N√™n l·ªõn h∆°n 1.000‚Ç´ nh∆∞ng nh·ªè h∆°n gi√° kh·ªüi ƒëi·ªÉm ƒë·ªÉ t·∫°o c·∫°nh tranh h·ª£p l√Ω.</p>
                    {{#if seller.productErrors.stepPrice}}<span class="field-error">{{seller.productErrors.stepPrice}}</span>{{/if}}
                  </div>

                  <div class="form-field {{#if seller.productErrors.buyNowPrice}}has-error{{/if}}">
                    <label for="product-buy-now">Gi√° mua ngay (tu·ª≥ ch·ªçn)</label>
                    <input id="product-buy-now" type="text" inputmode="numeric" name="buyNowPrice" value="{{seller.productForm.buyNowPrice}}" class="currency-input" placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng d√πng" />
                    {{#if seller.productErrors.buyNowPrice}}<span class="field-error">{{seller.productErrors.buyNowPrice}}</span>{{/if}}
                  </div>

                  <div class="form-field {{#if seller.productErrors.startDate}}has-error{{/if}}">
                    <label for="product-start-date">B·∫Øt ƒë·∫ßu</label>
                    <input id="product-start-date" type="datetime-local" name="startDate" value="{{seller.productForm.startDate}}" {{#if seller.editingProductId}}readonly{{else}}required{{/if}} />
                    {{#if seller.editingProductId}}
                      <p class="field-hint">Th·ªùi gian b·∫Øt ƒë·∫ßu kh√¥ng th·ªÉ thay ƒë·ªïi sau khi t·∫°o s·∫£n ph·∫©m.</p>
                    {{else}}
                      <p class="field-hint">Ch·ªçn th·ªùi ƒëi·ªÉm √≠t nh·∫•t sau hi·ªán t·∫°i 15 ph√∫t ƒë·ªÉ ng∆∞·ªùi mua chu·∫©n b·ªã.</p>
                    {{/if}}
                    {{#if seller.productErrors.startDate}}<span class="field-error">{{seller.productErrors.startDate}}</span>{{/if}}
                  </div>

                  <div class="form-field {{#if seller.productErrors.endDate}}has-error{{/if}}">
                    <label for="product-end-date">K·∫øt th√∫c</label>
                    <input id="product-end-date" type="datetime-local" name="endDate" value="{{seller.productForm.endDate}}" required />
                    <p class="field-hint">Phi√™n n√™n k√©o d√†i √≠t nh·∫•t 1 gi·ªù nh∆∞ng kh√¥ng qu√° 30 ng√†y.</p>
                    {{#if seller.productErrors.endDate}}<span class="field-error">{{seller.productErrors.endDate}}</span>{{/if}}
                  </div>

                  <div class="form-field form-field--full {{#if seller.productErrors.shortDescription}}has-error{{/if}}">
                    <label for="product-short-description">M√¥ t·∫£ ng·∫Øn</label>
                    <textarea id="product-short-description" name="shortDescription" rows="2" placeholder="T√≥m t·∫Øt ƒëi·ªÉm n·ªïi b·∫≠t" data-min-length="30" data-max-length="240">{{seller.productForm.shortDescription}}</textarea>
                    <p class="field-hint">Kho·∫£ng 30‚Äì240 k√Ω t·ª±, tr√°nh d√πng k√Ω hi·ªáu kh√≥ hi·ªÉu.</p>
                    {{#if seller.productErrors.shortDescription}}<span class="field-error">{{seller.productErrors.shortDescription}}</span>{{/if}}
                  </div>

                  <div class="form-field form-field--full {{#if seller.productErrors.fullDescription}}has-error{{/if}}">
                    <label for="product-full-description">M√¥ t·∫£ chi ti·∫øt</label>
                    <div class="quill-editor-wrapper">
                      <div id="quill-editor" class="quill-editor-container"></div>
                      <textarea id="product-full-description" name="fullDescription" rows="5" hidden>{{seller.productForm.fullDescription}}</textarea>
                    </div>
                    <p class="field-hint">H√£y cung c·∫•p th√¥ng tin r√µ r√†ng (T·ªëi thi·ªÉu 80 k√Ω t·ª±). S·ª≠ d·ª•ng thanh c√¥ng c·ª• ƒë·ªÉ ƒë·ªãnh d·∫°ng vƒÉn b·∫£n.</p>
                    {{#if seller.productErrors.fullDescription}}<span class="field-error">{{seller.productErrors.fullDescription}}</span>{{/if}}
                  </div>

                  <div class="form-field form-field--full {{#if seller.productErrors.productImages}}has-error{{/if}}">
                    <label for="product-images">·∫¢nh s·∫£n ph·∫©m (√≠t nh·∫•t 3 ·∫£nh)</label>
                    <div class="image-upload-container">
                      <div class="upload-tabs">
                        <button type="button" class="upload-tab active" data-tab="file">T·∫£i ·∫£nh t·ª´ m√°y</button>
                        <button type="button" class="upload-tab" data-tab="url">Nh·∫≠p link ·∫£nh</button>
                      </div>
                      
                      <div class="upload-panel" id="upload-file-panel">
                        <input id="product-images" type="file" name="productImages" accept="image/*" multiple />
                        <p class="field-hint">Ch·ªçn √≠t nh·∫•t 3 ·∫£nh t·ª´ thi·∫øt b·ªã (JPEG, PNG, GIF, WEBP). ·∫¢nh ƒë·∫ßu ti√™n s·∫Ω l√† ·∫£nh ƒë·∫°i di·ªán.</p>
                        <div id="image-preview-container" class="image-preview-grid"></div>
                      </div>
                      
                      <div class="upload-panel" id="upload-url-panel" style="display: none;">
                        <textarea id="product-image-urls" name="imageUrls" rows="4" placeholder="Nh·∫≠p m·ªói URL ·∫£nh tr√™n m·ªôt d√≤ng&#10;https://example.com/image1.jpg&#10;https://example.com/image2.jpg&#10;https://example.com/image3.jpg">{{seller.productForm.imageUrls}}</textarea>
                        <p class="field-hint">Nh·∫≠p URL ·∫£nh, m·ªói URL tr√™n m·ªôt d√≤ng. ·∫¢nh ƒë·∫ßu ti√™n s·∫Ω l√† ·∫£nh ƒë·∫°i di·ªán.</p>
                        <div id="url-preview-container" class="image-preview-grid"></div>
                      </div>
                    </div>
                    {{#if seller.productErrors.productImages}}<span class="field-error">{{seller.productErrors.productImages}}</span>{{/if}}
                    {{#if seller.productForm.existingImages}}
                      <div class="existing-images">
                        <p class="field-hint">·∫¢nh hi·ªán t·∫°i (ch·ªçn file m·ªõi ho·∫∑c nh·∫≠p URL n·∫øu mu·ªën thay ƒë·ªïi):</p>
                        <div class="image-preview-grid">
                          {{#each seller.productForm.existingImages}}
                            <div class="image-preview-item">
                              <img src="{{this}}" alt="·∫¢nh s·∫£n ph·∫©m" />
                            </div>
                          {{/each}}
                        </div>
                      </div>
                    {{/if}}
                  </div>

                  <div class="form-field form-field--inline">
                    <label class="checkbox">
                      <input type="checkbox" name="autoExtend" value="true" {{#if seller.productForm.autoExtend}}checked{{/if}} />
                      <span>T·ª± ƒë·ªông gia h·∫°n phi√™n khi s·∫Øp k·∫øt th√∫c</span>
                    </label>
                    <p class="field-hint">H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông k√©o d√†i phi√™n khi c√≤n √≠t th·ªùi gian.</p>
                  </div>
                </div>
                <div class="form-actions form-actions--between">
                  {{#if seller.editingProductId}}
                    <a href="/account/products" class="btn tertiary">Hu·ª∑ ch·ªânh s·ª≠a</a>
                    <button type="submit" class="btn primary">C·∫≠p nh·∫≠t s·∫£n ph·∫©m</button>
                  {{else}}
                    <button type="reset" class="btn tertiary">L√†m m·ªõi</button>
                    <button type="submit" class="btn primary">ƒêƒÉng s·∫£n ph·∫©m</button>
                  {{/if}}
                </div>
              </form>
            </div>
          </div>

          <aside class="account-panel-aside account-panel-aside--products">
            <div class="account-card account-card--stats">
              <h3>T·ªïng quan nhanh</h3>
              <ul class="seller-stats">
                <li><span>ƒêang b√°n</span><strong>{{seller.stats.active}}</strong></li>
                <li><span>B·∫£n nh√°p</span><strong>{{seller.stats.draft}}</strong></li>
                <li><span>ƒê√£ b√°n</span><strong>{{seller.stats.sold}}</strong></li>
              </ul>
            </div>

            <div class="account-card account-card--auto">
              <h3>Gia h·∫°n t·ª± ƒë·ªông</h3>
              <ul class="settings-list">
                <li>K√≠ch ho·∫°t khi c√≤n {{seller.autoExtendSettings.triggerMinutes}} ph√∫t cu·ªëi.</li>
                <li>Gia h·∫°n th√™m {{seller.autoExtendSettings.extendMinutes}} ph√∫t.</li>
              </ul>
              <p class="field-hint">B·∫°n c√≥ th·ªÉ t·∫Øt tu·ª≥ s·∫£n ph·∫©m b·∫±ng c√°ch b·ªè ch·ªçn ·ªü form t·∫°o.</p>
            </div>
          </aside>
        </div>
      </section>

      <section class="seller-tab-panel" data-tab-panel="requests" role="tabpanel" hidden>
        <section class="account-card account-card--requests">
          <header class="section-header">
            <h3>Y√™u c·∫ßu tham gia ƒë·∫•u gi√°</h3>
          </header>

          {{#if seller.bidRequests.length}}
            <table class="seller-requests">
              <thead>
                <tr>
                  <th>Ng∆∞·ªùi y√™u c·∫ßu</th>
                  <th>S·∫£n ph·∫©m</th>
                  <th>L√Ω do</th>
                  <th>Thao t√°c</th>
                </tr>
              </thead>
              <tbody>
                {{#each seller.bidRequests}}
                  <tr>
                    <td>
                      <a href="/users/{{bidderId}}/ratings" class="bidder-profile-link"><strong>{{bidderName}}</strong></a>
                      <div class="meta">{{bidderEmail}}</div>
                      <div class="meta">ƒê√°nh gi√°: {{bidderRatingPlus}} üëç / {{bidderRatingMinus}} üëé</div>
                      <div class="meta">G·ª≠i l√∫c {{formatDate createdAt 'HH:mm DD/MM/YYYY'}}</div>
                    </td>
                    <td>
                      <a href="/products/{{productId}}" target="_blank" rel="noopener">{{productTitle}}</a>
                    </td>
                    <td>
                      {{#if message}}
                        <p>{{message}}</p>
                      {{else}}
                        <p class="field-hint">Kh√¥ng c√≥ ghi ch√∫</p>
                      {{/if}}
                    </td>
                    <td>
                      <form method="post" action="/account/products/{{productId}}/bid-requests/{{id}}" class="request-actions">
                        <input type="text" name="note" placeholder="Ghi ch√∫ cho bidder (tu·ª≥ ch·ªçn)" />
                        <div class="form-actions">
                          <button type="submit" name="action" value="approve" class="btn primary btn-sm">Ch·∫•p thu·∫≠n</button>
                          <button type="submit" name="action" value="reject" class="btn secondary btn-sm">T·ª´ ch·ªëi</button>
                        </div>
                      </form>
                    </td>
                  </tr>
                {{/each}}
              </tbody>
            </table>
          {{else}}
            <p class="empty-state">Ch∆∞a c√≥ y√™u c·∫ßu m·ªõi.</p>
          {{/if}}
        </section>
      </section>

      <section class="seller-tab-panel" data-tab-panel="sales" role="tabpanel" hidden>
        <header class="section-header">
          <h3>Qu·∫£n l√Ω b√°n h√†ng</h3>
          <p>Theo d√µi phi√™n ƒëang b√°n v√† c√°c s·∫£n ph·∫©m ƒë√£ ch·ªët.</p>
        </header>

        <div class="account-products-board">
          <section class="account-products-column">
            <header>
              <h3>ƒêang b√°n</h3>
              <span>{{seller.stats.active}} s·∫£n ph·∫©m</span>
            </header>
            {{#if seller.sellingProducts.length}}
              <table class="seller-products">
                <thead>
                  <tr>
                    <th>T√™n s·∫£n ph·∫©m</th>
                    <th>Gi√° kh·ªüi ƒëi·ªÉm</th>
                    <th>Gi√° hi·ªán t·∫°i</th>
                    <th>K·∫øt th√∫c</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>H√†nh ƒë·ªông</th>
                  </tr>
                </thead>
                <tbody>
                  {{#each seller.sellingProducts}}
                    <tr>
                      <td class="col-title"><a href="/products/{{id}}">{{title}}</a></td>
                      <td>{{formatCurrency startPrice}}</td>
                      <td>{{formatCurrency currentPrice}}</td>
                      <td>{{#if endDate}}{{formatDate endDate 'HH:mm DD/MM/YYYY'}}{{else}}‚Äî{{/if}}</td>
                      <td>
                        {{#if order}}
                          <span class="status-pill status-pill--order">
                            {{#if (eq order.status 'awaiting_payment_details')}}
                              Ch·ªù thanh to√°n
                            {{else}}
                              {{localizeFulfillmentStatus order.status}}
                            {{/if}}
                          </span>
                        {{else}}
                          {{#if auctionEnded}}
                            <span class="status-pill status-pill--ended">K·∫øt th√∫c</span>
                          {{else}}
                            <span class="status-pill status-pill--active">{{statusLabel status}}</span>
                          {{/if}}
                        {{/if}}
                      </td>
                      <td>
                        <div class="action-links">
                          <i class="bi bi-pen">
                            <a href="/account/products/{{id}}/edit">S·ª≠a</a>
                          </i>
                          <i class="bi bi-trash">
                            <a href="/account/products/{{id}}/delete" style="color: red;" onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën xo√° s·∫£n ph·∫©m n√†y?');">Xo√°</a>
                          </i>
                        </div>
                      </td>
                    </tr>
                  {{/each}}
                </tbody>
              </table>
            {{else}}
              <p class="empty-state">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o ƒëang ƒë∆∞·ª£c ƒë·∫•u gi√°.</p>
            {{/if}}
          </section>

          <section class="account-products-column">
            <header>
              <h3>ƒê√£ b√°n</h3>
              <span>{{seller.stats.sold}} s·∫£n ph·∫©m</span>
            </header>
            {{#if seller.soldProducts.length}}
              <table class="seller-products">
                <thead>
                  <tr>
                    <th>T√™n s·∫£n ph·∫©m</th>
                    <th>Gi√° kh·ªüi ƒëi·ªÉm</th>
                    <th>Gi√° k·∫øt th√∫c</th>
                    <th>K·∫øt th√∫c</th>
                    <th>Tr·∫°ng th√°i</th>
                  </tr>
                </thead>
                <tbody>
                  {{#each seller.soldProducts}}
                    <tr>
                      <td class="col-title"><a href="/products/{{id}}">{{title}}</a></td>
                      <td>{{formatCurrency startPrice}}</td>
                      <td>{{#if currentPrice}}{{formatCurrency currentPrice}}{{else}}‚Äî{{/if}}</td>
                      <td>{{#if endDate}}{{formatDate endDate 'HH:mm DD/MM/YYYY'}}{{else}}‚Äî{{/if}}</td>
                      <td>
                        {{#if (or (eq order.status 'transaction_completed') (eq status 'transaction_completed'))}}
                          {{#if order.hasRated}}
                            <span class="status-pill status-pill--order">ƒê√£ ƒë√°nh gi√°</span>
                          {{else}}
                            <span class="status-pill status-pill--processing">Ch·ªù ƒë√°nh gi√°</span>
                          {{/if}}
                        {{else}}
                          <span class="status-pill status-pill--processing">ƒêang x·ª≠ l√Ω</span>
                        {{/if}}
                      </td>
                    </tr>
                  {{/each}}
                </tbody>
              </table>
            {{else}}
              <p class="empty-state">B·∫°n ch∆∞a c√≥ s·∫£n ph·∫©m n√†o ƒë√£ b√°n xong.</p>
            {{/if}}
          </section>
        </div>
      </section>
    </div>
  </div>
</section>
